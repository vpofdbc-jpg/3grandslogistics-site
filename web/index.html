<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3Grands Logistics Secure App</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for the Afrocentric palette */
        :root {
            /* Kente-inspired Colors */
            --color-red-brown: #6F2A1C; /* Saturated Red/Brown */
            --color-gold-yellow: #D4A74F; /* Vibrant Gold/Yellow */
            --color-deep-green: #2D4C2D; /* Deep Forest Green */
            --color-warm-cream: #F5F5DC; /* Warm Cream/Beige */
            --color-deep-brown-black: #2A1A0A; /* Near-Black/Deep Brown */
        }
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--color-warm-cream); 
            color: var(--color-deep-brown-black); /* Default text color */
            padding: 1rem;
        }
        
        /* Custom Tailwind Utilities (for use in JS rendering) */
        .text-red-brown { color: var(--color-red-brown); }
        .bg-red-brown { background-color: var(--color-red-brown); }
        .hover\:bg-red-brown-dark:hover { background-color: #5A2016; } /* Slightly darker on hover */
        .text-gold-yellow { color: var(--color-gold-yellow); }
        .border-gold-yellow { border-color: var(--color-gold-yellow); }
        .focus\:ring-gold-yellow:focus { --tw-ring-color: var(--color-gold-yellow); }
        .focus\:border-gold-yellow:focus { border-color: var(--color-gold-yellow); }
        .text-deep-green { color: var(--color-deep-green); }
        .bg-deep-green { background-color: var(--color-deep-green); }
        .text-warm-cream { color: var(--color-warm-cream); }
        .bg-warm-cream { background-color: var(--color-warm-cream); }
        .text-deep-brown-black { color: var(--color-deep-brown-black); }
        .bg-deep-brown-black { background-color: var(--color-deep-brown-black); }

        /* Custom spinner for better visual integration */
        .custom-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--color-red-brown);
            border-top-color: var(--color-gold-yellow);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        /* Specific spinner for buttons */
        .custom-spinner.w-5.h-5 {
            border-width: 2px;
            width: 1.25rem;
            height: 1.25rem;
            margin-right: 0.5rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Modal Backdrop */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        /* Disabled Button Style for consistency */
        .disabled-btn {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: var(--color-deep-brown-black) !important; 
        }
    </style>
</head>
<body>

    <div id="app" class="w-full max-w-lg">
        </div>

    <div id="modal-container"></div>

    <script type="module">
        // =========================================================================
        // --- FIREBASE IMPORTS: ENABLED ---
        // =========================================================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword,
            signOut,
            setPersistence,
            browserSessionPersistence
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        // NEW: Import Firebase Functions SDK
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";

        // =========================================================================

        let app, auth, db, functions; // NEW: Added 'functions'
        let authReady = false; 
        let isFirebaseUnavailable = false; 
        let currentUser = null; 
        let currentView = 'dashboard'; 
        
        // --- State Variables ---
        let isVWCSubscribed = false; 
        let customerProfile = {
            name: '',
            address: '',
            yearOfBirth: '' // Stored as a string (YYYY)
        };
        
        let vwcPackages = [];


        const appContainer = document.getElementById('app');
        const modalContainer = document.getElementById('modal-container');
        let currentAuthMode = 'login'; 

        // =========================================================================
        // --- STEP 1: FIREBASE CONFIG --- 
        // =========================================================================
        const DEV_MODE_FIREBASE_CONFIG = {
            apiKey: "AIzaSyCahMIf5Q3YBsjfXB30YpAgWfycvT0gCqQ",
            authDomain: "grandslogistics-8af41.firebaseapp.com",
            projectId: "grandslogistics-8af41",
            storageBucket: "grandslogistics-8af41.firebasestorage.app",
            messagingSenderId: "267189664335",
            appId: "1:267189664335:web:ad23fb36b6aabfc52e883a",
            measurementId: "G-00890Z62TC" 
        }; 
        // =========================================================================

        // --- Utility Functions ---
        const isValidEmail = (email) => /\S+@\S+\.\S+/i.test(email);
        
        const renderLogo = () => {
            const logoPath = 'logo-128x128.png'; 
            return `<img src="${logoPath}" 
                            alt="3Grands Logistics Logo" 
                            onerror="this.onerror=null; this.src='https://placehold.co/80x80/2D4C2D/F5F5DC?text=3G'"
                            class="w-20 h-20 object-contain mx-auto">`; 
        }

        // --- State Management Functions (Using Local Storage as a cache) ---
        const PROFILE_KEY = '3Grands_Profile_';
        const PACKAGES_KEY = '3Grands_VWC_Packages_';
        const SUB_KEY = '3Grands_VWC_Subscribed_';


        const loadProfile = (uid) => {
            if (!uid) return;
            try {
                const storedProfile = localStorage.getItem(PROFILE_KEY + uid);
                if (storedProfile) {
                    customerProfile = JSON.parse(storedProfile);
                } else {
                    customerProfile = { name: '', address: '', yearOfBirth: '' };
                }
                
                const storedSub = localStorage.getItem(SUB_KEY + uid);
                isVWCSubscribed = storedSub === 'true';

            } catch (e) {
                console.error("Error loading profile/subscription from local storage:", e);
                customerProfile = { name: '', address: '', yearOfBirth: '' };
                isVWCSubscribed = false;
            }
        };

        const saveProfile = (uid) => {
            if (!uid) return false;
            localStorage.setItem(PROFILE_KEY + uid, JSON.stringify(customerProfile));
            return true;
        };
        
        const setSubscriptionStatus = (uid, status) => {
             if (!uid) return;
             isVWCSubscribed = status;
             localStorage.setItem(SUB_KEY + uid, status ? 'true' : 'false');
        }
        
        const loadVWCPackages = (uid) => {
             if (!uid) return;
             vwcPackages = JSON.parse(localStorage.getItem(PACKAGES_KEY + uid) || '[]');
        };

        const saveVWCPackages = (uid) => {
             if (!uid) return false;
             localStorage.setItem(PACKAGES_KEY + uid, JSON.stringify(vwcPackages));
             return true;
        };

        const showModal = (content, actionCallback = null) => {
            modalContainer.innerHTML = `
                <div class="modal-overlay">
                    <div class="bg-white p-6 sm:p-8 rounded-xl shadow-2xl w-11/12 max-w-lg transform transition-all duration-300">
                        ${content}
                        <div class="mt-6 flex justify-end space-x-3">
                            <button id="modal-close-btn" class="px-4 py-2 text-sm font-semibold rounded-lg bg-gray-200 text-deep-brown-black hover:bg-gray-300 transition duration-150">
                                Close
                            </button>
                            ${actionCallback ? 
                                `<button id="modal-action-btn" class="px-4 py-2 text-sm font-semibold rounded-lg bg-deep-green text-warm-cream hover:bg-deep-brown-black transition duration-150">
                                    Proceed
                                </button>` : ''
                            }
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('modal-close-btn').addEventListener('click', () => {
                modalContainer.innerHTML = '';
            });

            if (actionCallback) {
                document.getElementById('modal-action-btn').addEventListener('click', () => {
                    modalContainer.innerHTML = ''; // Close modal before action
                    actionCallback();
                });
            }
        };


        // --- Core Application Listeners ---
        
        const handleAuthAction = async (isRegister, email, password) => {
            const errorBox = document.getElementById('auth-error');
            const submitBtn = document.getElementById('submit-btn');

            errorBox.textContent = '';

            if (!isValidEmail(email)) {
                errorBox.textContent = 'Please enter a valid email address.';
                return;
            }
            if (password.length < 6) {
                errorBox.textContent = 'Password must be at least 6 characters.';
                return;
            }

            if (isFirebaseUnavailable || !auth) {
                 errorBox.textContent = 'Authentication service is unavailable. Check your connection.';
                 return;
            }

            submitBtn.disabled = true;
            submitBtn.classList.add('disabled-btn');

            try {
                if (isRegister) {
                    await createUserWithEmailAndPassword(auth, email, password);
                } else {
                    await setPersistence(auth, browserSessionPersistence);
                    await signInWithEmailAndPassword(auth, email, password);
                }
            } catch (error) {
                let errorMessage = 'An unknown authentication error occurred.';
                if (error.code) {
                    errorMessage = error.message.replace(/firebase:/i, '').replace(/\(auth.*\)/i, '').trim();
                }
                errorBox.textContent = `Error: ${errorMessage}`;
            } finally {
                submitBtn.disabled = false;
                submitBtn.classList.remove('disabled-btn');
            }
        };

        const handleSignOut = async () => {
            if (isFirebaseUnavailable || !auth) {
                 currentUser = null;
                 currentView = 'login';
                 renderApp();
                 return;
            }
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Sign Out Error:", error);
            }
        };

        const switchAuthMode = () => {
            currentAuthMode = currentAuthMode === 'login' ? 'register' : 'login';
            renderLogin();
        };

        const attachLoginListeners = (isRegister) => {
            const form = document.getElementById('auth-form');
            const switchBtn = document.getElementById('switch-mode-btn');

            if (form) {
                form.addEventListener('submit', (event) => {
                    event.preventDefault();
                    const email = document.getElementById('email').value.trim();
                    const password = document.getElementById('password').value;
                    handleAuthAction(isRegister, email, password);
                });
            }
            
            if (switchBtn) {
                switchBtn.addEventListener('click', switchAuthMode);
            }
        };

        const attachDashboardListeners = () => {
            const signOutBtn = document.getElementById('sign-out-btn');
            const profileBtn = document.getElementById('profile-btn'); 
            const odpdsBtn = document.getElementById('odpds-service-btn');
            const vwcBtn = document.getElementById('vwc-service-btn');
            const returnBtn = document.getElementById('openReturnModalBtn'); 
            const viewAllActivityBtn = document.getElementById('view-all-activity-btn');
            const billingPaymentsBtn = document.getElementById('billing-payments-btn'); // New button

            if (signOutBtn) {
                signOutBtn.addEventListener('click', handleSignOut);
            }
            
            if (profileBtn) {
                profileBtn.addEventListener('click', () => {
                    currentView = 'profile';
                    renderApp();
                });
            }

            if (odpdsBtn) {
                odpdsBtn.addEventListener('click', (e) => {
                    if (odpdsBtn.disabled || odpdsBtn.classList.contains('disabled-btn')) {
                        e.preventDefault();
                        return;
                    }

                    currentView = 'odpds';
                    renderApp();
                });
            }

            if (vwcBtn) {
                vwcBtn.addEventListener('click', (e) => {
                    if (vwcBtn.disabled || vwcBtn.classList.contains('disabled-btn')) {
                        e.preventDefault();
                        return;
                    }

                    // Check if already subscribed
                    if (isVWCSubscribed) {
                        currentView = 'vwc';
                        renderApp();
                    } else {
                        // Show subscription modal
                        const content = `
                            <h3 class="text-2xl font-bold text-deep-green mb-3">VWC Service Rules & Subscription</h3>
                            <p class="text-deep-brown-black mb-4">
                                The **Vendor to Warehouse to Customer (VWC)** service allows you to place orders with your vendors and ship them to our unique warehouse address for consolidation.
                            </p>
                            <ul class="list-disc list-inside text-sm text-deep-brown-black space-y-2 p-4 bg-warm-cream rounded-lg border border-gold-yellow">
                                <li>We will only hold packages for **no more than 60 days**.</li>
                                <li>Industrial-grade appliances, safes, or generators, car engines, large pallet orders, or unboxed furniture must use the **On-Demand Service**.</li>
                                <li>The package must **NOT** exceed **108 inches (9ft)** in its longest dimension.</li>
                                <li>The package must **NOT** exceed **150 lbs** in weight.</li>
                                <li class="text-red-brown font-semibold">**Security Reminder:** Package release requires confirming the **Year of Birth** from your profile.</li>
                            </ul>
                            <div class="mt-4 p-3 bg-gold-yellow/30 rounded-lg text-center">
                                <p class="text-xl font-extrabold text-deep-brown-black">Monthly Subscription: <span class="text-red-brown">$23.99</span></p>
                                <p class="text-sm text-deep-brown-black/70 mt-1">This recurring charge provides unlimited access to VWC consolidation services.</p>
                            </div>
                        `;
                        showModal(content, async () => { // ADDED async here
                            // Disable the button and show loading state
                            // This part ensures the modal's proceed button also shows loading feedback
                            const modalActionBtn = document.getElementById('modal-action-btn');
                            if (modalActionBtn) {
                                modalActionBtn.disabled = true;
                                modalActionBtn.classList.add('disabled-btn');
                                modalActionBtn.innerHTML = '<span class="custom-spinner w-5 h-5 border-white"></span> Initiating Checkout...'; // Add a spinner
                            }

                            try {
                                const createStripeSession = httpsCallable(functions, 'createStripeCheckoutSession');
                                const result = await createStripeSession();
                                const { url: stripeCheckoutUrl } = result.data;

                                if (stripeCheckoutUrl) {
                                    window.location.href = stripeCheckoutUrl; // Redirect to Stripe Checkout
                                } else {
                                    showModal(
                                        `<h3 class="text-2xl font-bold text-red-brown mb-3">Error!</h3>
                                         <p class="text-deep-brown-black">Failed to get Stripe checkout URL. Please try again.</p>`
                                    );
                                    // Reset modal button state if an error occurred before redirect
                                    if (modalActionBtn) {
                                        modalActionBtn.disabled = false;
                                        modalActionBtn.classList.remove('disabled-btn');
                                        modalActionBtn.textContent = 'Proceed';
                                    }
                                }
                            } catch (error) {
                                console.error("Error calling Cloud Function for Stripe Checkout:", error);
                                let errorMessage = error.message;
                                if (error.code === 'unauthenticated') {
                                    errorMessage = 'You must be logged in to subscribe.';
                                } else if (error.code === 'internal') {
                                    errorMessage = 'A server error occurred. Please try again.';
                                }
                                showModal(
                                    `<h3 class="text-2xl font-bold text-red-brown mb-3">Subscription Error</h3>
                                     <p class="text-deep-brown-black">${errorMessage}</p>`
                                );
                                // Reset modal button state if an error occurred
                                if (modalActionBtn) {
                                    modalActionBtn.disabled = false;
                                    modalActionBtn.classList.remove('disabled-btn');
                                    modalActionBtn.textContent = 'Proceed';
                                }
                            }
                        });
                    }
                });
            }

            // Listener for the Quick Return Request button
            if (returnBtn) {
                returnBtn.addEventListener('click', () => {
                    showModal(
                        `<h3 class="text-2xl font-bold text-red-brown mb-3">Initiate Return Request</h3>
                         <p class="text-deep-brown-black">You are about to start a return request. Please ensure you have your order details ready.</p>
                         <p class="text-xs text-deep-brown-black/70 mt-2">Further steps will be required to complete the return process.</p>`,
                        () => {
                            // Placeholder for actual return request form/logic
                            console.log('User initiated Quick Return Request.');
                            alert('Return request initiated! Please follow the instructions to provide more details!');
                        }
                    );
                });
            }

            // Listener for the View All Activity button
            if (viewAllActivityBtn) {
                viewAllActivityBtn.addEventListener('click', () => {
                    currentView = 'activity';
                    renderApp();
                });
            }

            // New listener for the Billing & Payments button
            if (billingPaymentsBtn) {
                billingPaymentsBtn.addEventListener('click', () => {
                    currentView = 'billingPayments';
                    renderApp();
                });
            }
        };
        
        const attachProfileListeners = () => {
            const form = document.getElementById('profile-form');
            const backBtn = document.getElementById('profile-back-to-dashboard-btn');
            const statusBox = document.getElementById('profile-status');
            
            document.getElementById('profile-name').value = customerProfile.name;
            document.getElementById('profile-address').value = customerProfile.address;
            document.getElementById('profile-yob').value = customerProfile.yearOfBirth;

            // Display subscription status in profile
            const vwcSubscriptionStatusElement = document.getElementById('vwc-subscription-status');
            if (vwcSubscriptionStatusElement) {
                vwcSubscriptionStatusElement.textContent = isVWCSubscribed ? 'Active' : 'Inactive';
                vwcSubscriptionStatusElement.className = `font-semibold ${isVWCSubscribed ? 'text-deep-green' : 'text-red-brown'}`;
            }

            if (backBtn) {
                backBtn.addEventListener('click', () => {
                    currentView = 'dashboard';
                    renderApp();
                });
            }

            if (form) {
                form.addEventListener('submit', (event) => {
                    event.preventDefault();
                    
                    const name = document.getElementById('profile-name').value.trim();
                    const address = document.getElementById('profile-address').value.trim();
                    const yob = document.getElementById('profile-yob').value.trim();
                    
                    statusBox.className = 'text-sm font-medium text-red-brown mt-3';
                    statusBox.textContent = '';
                    
                    if (!name || !address || !yob) {
                        statusBox.textContent = 'All fields are required.';
                        return;
                    }
                    if (yob.length !== 4 || isNaN(parseInt(yob))) {
                        statusBox.textContent = 'Year of Birth must be a four-digit number (YYYY).';
                        return;
                    }
                    const currentYear = new Date().getFullYear();
                    if (parseInt(yob) > currentYear || parseInt(yob) < 1900) {
                        statusBox.textContent = 'Please enter a valid Year of Birth.';
                        return;
                    }

                    customerProfile.name = name;
                    customerProfile.address = address;
                    customerProfile.yearOfBirth = yob;

                    if (saveProfile(currentUser?.uid)) {
                        statusBox.className = 'text-sm font-medium text-deep-green mt-3';
                        statusBox.textContent = '✅ Profile updated successfully!';
                        setTimeout(() => {
                             currentView = 'dashboard';
                             renderApp();
                        }, 1000);
                    } else {
                        statusBox.textContent = 'Error: Could not save profile data.';
                    }
                });
            }
        };
        
        const attachVWCFormListeners = () => {
            const form = document.getElementById('vwc-pre-alert-form');
            const alertStatus = document.getElementById('vwc-alert-status');
            
            // Disable form if not subscribed
            if (form) {
                const formInputs = form.querySelectorAll('input, button');
                if (!isVWCSubscribed) {
                    formInputs.forEach(input => input.disabled = true);
                    alertStatus.textContent = 'Subscription required to submit pre-alerts.';
                    alertStatus.classList.add('text-red-brown');
                } else {
                     formInputs.forEach(input => input.disabled = false);
                     alertStatus.textContent = ''; // Clear previous message
                     alertStatus.classList.remove('text-red-brown');
                }
            }


            if (form && isVWCSubscribed) {
                form.addEventListener('submit', (event) => {
                    event.preventDefault();
                    
                    const trackingNumber = document.getElementById('tracking-number').value.trim();
                    const vendor = document.getElementById('vendor-name').value.trim();
                    const contents = document.getElementById('package-contents').value.trim();
                    
                    alertStatus.className = 'text-sm font-medium text-red-brown mt-3';
                    alertStatus.textContent = '';
                    
                    if (!trackingNumber || !vendor || !contents) {
                        alertStatus.textContent = 'All fields are required.';
                        return;
                    }
                    
                    if (vwcPackages.some(p => p.trackingNumber === trackingNumber)) {
                         alertStatus.textContent = 'Error: This tracking number has already been submitted.';
                         return;
                    }

                    const newPackage = {
                        id: Date.now(),
                        trackingNumber,
                        vendor,
                        contents,
                        status: 'Monitoring (Pre-Alert)', 
                        submissionTime: new Date().toLocaleString()
                    };
                    
                    vwcPackages.push(newPackage);
                    saveVWCPackages(currentUser?.uid);
                    
                    form.reset();
                    alertStatus.className = 'text-sm font-medium text-deep-green mt-3';
                    alertStatus.textContent = '✅ Package Pre-Alert submitted!';
                    
                    renderVWCPackageList();
                });
            }
        };
        
        // --- VWC Status Update Logic (Manual Simulation) ---

        const handleManualStatusUpdate = (event) => {
            // Note: The package ID is stored as a number, so we parse it.
            const packageId = parseInt(event.currentTarget.getAttribute('data-package-id'));
            const packageIndex = vwcPackages.findIndex(p => p.id === packageId);

            if (packageIndex > -1) {
                let newStatus = '';
                const currentStatus = vwcPackages[packageIndex].status;

                // Logic to cycle through the statuses:
                if (currentStatus === 'Monitoring (Pre-Alert)') {
                    newStatus = 'Out for Delivery to Warehouse'; // Simulates Amazon update
                } else if (currentStatus === 'Out for Delivery to Warehouse') {
                    newStatus = 'Received at Warehouse (Ready for Consolidation)'; // Simulates your warehouse scan
                } else if (currentStatus === 'Received at Warehouse (Ready for Consolidation)') {
                    newStatus = 'Ready for Customer Pickup/Shipping';
                } else {
                    // Once finished, reset it for demonstration purposes
                    newStatus = 'Monitoring (Pre-Alert)'; 
                }

                vwcPackages[packageIndex].status = newStatus;
                saveVWCPackages(currentUser?.uid);
                
                // Re-render the list to show the change immediately
                renderVWCPackageList(); 
            }
        };
        
        // --- function to render only the package list dynamically ---
        const renderVWCPackageList = () => {
             const packageListContainer = document.getElementById('vwc-package-list');
             if (!packageListContainer) return;

             if (vwcPackages.length === 0) {
                 packageListContainer.innerHTML = `
                    <div class="p-4 bg-warm-cream/50 rounded-lg text-center text-deep-brown-black/70 italic">
                        No packages have been submitted for consolidation yet.
                    </div>
                 `;
                 return;
             }

             const listItems = vwcPackages.map(p => `
                 <li class="flex flex-col sm:flex-row justify-between items-start sm:items-center p-3 border-b border-gold-yellow/50 hover:bg-gold-yellow/10 transition duration-150">
                     <div class="mb-2 sm:mb-0 flex-grow">
                         <p class="font-semibold text-deep-brown-black">${p.trackingNumber}</p>
                         <p class="text-xs text-deep-brown-black/70">From: ${p.vendor} | Contents: ${p.contents}</p>
                     </div>
                     <div class="flex items-center space-x-3 w-full sm:w-auto">
                         <span class="text-sm font-bold ${p.status.includes('Received') ? 'text-deep-green' : p.status.includes('Out for Delivery') ? 'text-gold-yellow' : 'text-red-brown'}">
                             ${p.status}
                         </span>
                         <button data-package-id="${p.id}" 
                                 class="update-status-btn bg-deep-brown-black text-warm-cream px-3 py-1 text-xs rounded-lg hover:bg-deep-green transition duration-150 whitespace-nowrap">
                             Simulate Scan
                         </button>
                     </div>
                 </li>
             `).join('');

             packageListContainer.innerHTML = `
                 <ul class="divide-y divide-gold-yellow/50">
                     ${listItems}
                 </ul>
             `;
             
             // Attach listener after rendering
             document.querySelectorAll('.update-status-btn').forEach(button => {
                 button.addEventListener('click', handleManualStatusUpdate);
             });
        };


        const attachVWCListeners = () => {
            const backBtn = document.getElementById('vwc-back-to-dashboard-btn');
            const subscribeBtn = document.getElementById('vwc-subscribe-btn');
            const preAlertFormSection = document.getElementById('vwc-pre-alert-form-section');
            const packageListSection = document.getElementById('vwc-package-list-section');
            const warehouseAddressContainer = document.getElementById('warehouse-address-container');
            const notSubscribedMessage = document.getElementById('not-subscribed-message');


            if (backBtn) {
                backBtn.addEventListener('click', () => {
                    currentView = 'dashboard';
                    renderApp();
                });
            }
            
            if (!isVWCSubscribed) {
                // Show subscription button and message, hide form/address
                if (subscribeBtn) {
                    subscribeBtn.classList.remove('hidden');
                    subscribeBtn.textContent = 'Subscribe to VWC Service ($23.99/month)';
                    subscribeBtn.addEventListener('click', async () => { // NEW: async handler
                        const content = `
                            <h3 class="text-2xl font-bold text-deep-green mb-3">Confirm VWC Subscription</h3>
                            <p class="text-deep-brown-black mb-4">
                                By clicking 'Proceed', you agree to a monthly charge of **$23.99** for unlimited VWC package consolidation and delivery access.
                            </p>
                            <ul class="list-disc list-inside text-sm text-deep-brown-black space-y-2 p-4 bg-warm-cream rounded-lg border border-gold-yellow">
                                <li>We will only hold packages for **no more than 60 days**.</li>
                                <li>Industrial-grade appliances, safes, or generators, car engines, large pallet orders, or unboxed furniture must use the **On-Demand Service**.</li>
                                <li>The package must **NOT** exceed **108 inches (9ft)** in its longest dimension.</li>
                                <li>The package must **NOT** exceed **150 lbs** in weight.</li>
                                <li class="text-red-brown font-semibold">**Security Reminder:** Package release requires confirming the **Year of Birth** from your profile.</li>
                            </ul>
                        `;
                        showModal(content, async () => { // NEW: async actionCallback
                            // Disable the button and show loading state
                            const modalActionBtn = document.getElementById('modal-action-btn');
                            if (modalActionBtn) {
                                modalActionBtn.disabled = true;
                                modalActionBtn.classList.add('disabled-btn');
                                modalActionBtn.innerHTML = '<span class="custom-spinner w-5 h-5 border-white"></span> Initiating Checkout...'; // Add a spinner
                            }

                            try {
                                // NEW: Call the Cloud Function
                                const createStripeSession = httpsCallable(functions, 'createStripeCheckoutSession');
                                const result = await createStripeSession();
                                const { url: stripeCheckoutUrl } = result.data;

                                if (stripeCheckoutUrl) {
                                    window.location.href = stripeCheckoutUrl; // Redirect to Stripe Checkout
                                } else {
                                    showModal(
                                        `<h3 class="text-2xl font-bold text-red-brown mb-3">Error!</h3>
                                         <p class="text-deep-brown-black">Failed to get Stripe checkout URL. Please try again.</p>`
                                    );
                                    // Reset modal button state if an error occurred before redirect
                                    if (modalActionBtn) {
                                        modalActionBtn.disabled = false;
                                        modalActionBtn.classList.remove('disabled-btn');
                                        modalActionBtn.textContent = 'Proceed';
                                    }
                                }
                            } catch (error) {
                                console.error("Error calling Cloud Function for Stripe Checkout:", error);
                                let errorMessage = error.message;
                                if (error.code === 'unauthenticated') {
                                    errorMessage = 'You must be logged in to subscribe.';
                                } else if (error.code === 'internal') { // NEW: Catch internal server errors
                                    errorMessage = 'A server error occurred. Please try again.';
                                }
                                showModal(
                                    `<h3 class="text-2xl font-bold text-red-brown mb-3">Subscription Error</h3>
                                     <p class="text-deep-brown-black">${errorMessage}</p>`
                                );
                                // Reset modal button state if an error occurred
                                if (modalActionBtn) {
                                    modalActionBtn.disabled = false;
                                    modalActionBtn.classList.remove('disabled-btn');
                                    modalActionBtn.textContent = 'Proceed';
                                }
                            }
                        });
                    });
                }
                if (preAlertFormSection) preAlertFormSection.classList.add('hidden');
                if (packageListSection) packageListSection.classList.add('hidden');
                if (warehouseAddressContainer) warehouseAddressContainer.classList.add('hidden');
                if (notSubscribedMessage) notSubscribedMessage.classList.remove('hidden');

            } else {
                // Hide subscription button and message, show form/address
                if (subscribeBtn) subscribeBtn.classList.add('hidden');
                if (preAlertFormSection) preAlertFormSection.classList.remove('hidden');
                if (packageListSection) packageListSection.classList.remove('hidden');
                if (warehouseAddressContainer) warehouseAddressContainer.classList.remove('hidden');
                if (notSubscribedMessage) not SubscribedMessage.classList.add('hidden');
            }
            
            attachVWCFormListeners(); 
        }

        const attachODPDSListeners = () => {
            const backBtn = document.getElementById('odpds-back-to-dashboard-btn');

            if (backBtn) {
                backBtn.addEventListener('click', () => {
                    currentView = 'dashboard';
                    renderApp();
                });
            }
            
            const runODPDSCheck = () => {
                const weight = parseFloat(document.getElementById('odpds-weight').value);
                const dimension = parseFloat(document.getElementById('odpds-dimension').value);
                const pickupMiles = parseFloat(document.getElementById('odpds-pickup-miles').value);
                const deliveryMiles = parseFloat(document.getElementById('odpds-delivery-miles').value);
                
                const resultBox = document.getElementById('odpds-result-box');
                const errorBox = document.getElementById('odpds-error');
                const calculateBtn = document.getElementById('odpds-calculate-btn');
                errorBox.textContent = '';
                calculateBtn.disabled = true;
                calculateBtn.classList.add('disabled-btn');
                resultBox.innerHTML = '';


                if (isNaN(weight) || weight <= 0 || isNaN(dimension) || dimension <= 0 || isNaN(pickupMiles) || pickupMiles < 0 || isNaN(deliveryMiles) || deliveryMiles < 0) {
                    errorBox.textContent = 'Please enter valid positive values for all fields.';
                    calculateBtn.classList.remove('bg-deep-green', 'bg-red-brown');
                    calculateBtn.classList.add('bg-deep-brown-black', 'disabled-btn');
                    calculateBtn.innerHTML = 'Enter details to calculate rate';
                    return;
                }
                
                calculateBtn.disabled = false;
                calculateBtn.classList.remove('disabled-btn', 'bg-deep-brown-black');
                calculateBtn.classList.add('bg-deep-green', 'hover:bg-deep-brown-black');
                calculateBtn.innerHTML = 'Calculate Final Rate';

                const perMileRate = 3.79;
                const totalMiles = pickupMiles + deliveryMiles;
                const mileRate = totalMiles * perMileRate;
                const weightRate = weight * 1.50;
                const dimensionRate = dimension * 0.50;
                const wndRate = Math.max(weightRate, dimensionRate);
                const finalCharge = Math.max(mileRate, wndRate);
                
                const formatCurrency = (amount) => `$${amount.toFixed(2)}`;

                resultBox.innerHTML = `
                    <h4 class="text-lg font-bold text-deep-green mt-4 border-t pt-3">Calculation Details:</h4>
                    <ul class="text-sm space-y-1">
                        <li>**Total Miles:** ${totalMiles.toFixed(1)} miles</li>
                        <li>**Rate based on Miles ($${perMileRate}/mi):** ${formatCurrency(mileRate)}</li>
                        <li>**Rate based on W/D Max Rate:** ${formatCurrency(wndRate)}</li>
                    </ul>
                    <div class="mt-4 p-3 bg-gold-yellow/30 rounded-lg">
                        <p class="text-xl font-extrabold text-deep-brown-black">Final Estimated Charge: <span class="text-red-brown">${formatCurrency(finalCharge)}</span></p>
                        <p class="text-xs text-deep-brown-black/70 mt-1">Charged is the greater of the Miles Rate (${formatCurrency(mileRate)}) vs. the Weight/Dimension Rate (${formatCurrency(wndRate)}). **YOB ${customerProfile.yearOfBirth}** required for release.</p>
                    </div>
                `;

                calculateBtn.onclick = () => showModal(
                    `<h3 class="text-2xl font-bold text-deep-green mb-3">Confirm On-Demand Service</h3>
                     <p class="text-deep-brown-black">Your estimated charge is **${formatCurrency(finalCharge)}**. Confirm booking with **Year of Birth ${customerProfile.yearOfBirth}** as the security release code.</p>`,
                    () => console.log('User confirmed ODPDS booking.') 
                );
            };

            document.getElementById('odpds-weight').addEventListener('input', runODPDSCheck);
            document.getElementById('odpds-dimension').addEventListener('input', runODPDSCheck);
            document.getElementById('odpds-pickup-miles').addEventListener('input', runODPDSCheck);
            document.getElementById('odpds-delivery-miles').addEventListener('input', runODPDSCheck);
            
            runODPDSCheck();
        };

        // New function to attach listeners for the Activity Log
        const attachActivityListeners = () => {
            const backBtn = document.getElementById('activity-back-to-dashboard-btn');
            if (backBtn) {
                backBtn.addEventListener('click', () => {
                    currentView = 'dashboard';
                    renderApp();
                });
            }
        };

        // New function to attach listeners for Billing & Payments
        const attachBillingPaymentsListeners = () => {
            const backBtn = document.getElementById('billing-payments-back-to-dashboard-btn');
            if (backBtn) {
                backBtn.addEventListener('click', () => {
                    currentView = 'dashboard';
                    renderApp();
                });
            }
        };


        // =========================================================================
        // --- MAIN APPLICATION ENTRY POINT ---
        // =========================================================================

        const renderApp = () => {
            if (!authReady) {
                renderLoading();
                return;
            }

            if (currentUser) {
                if (currentView === 'profile') {
                    renderProfile();
                } else if (currentView === 'vwc') {
                    renderVWCService();
                } else if (currentView === 'odpds') {
                    renderODPDS();
                } else if (currentView === 'activity') {
                    renderActivity();
                } else if (currentView === 'billingPayments') { // New condition for billing & payments
                    renderBillingPayments();
                }
                else {
                    renderDashboard(); 
                }
            } else {
                renderLogin();
            }
        };


        // --- Firebase Initialization and Auth Setup (Initial Entry Point) ---
        const initializeFirebase = async () => {
            try {
                app = initializeApp(DEV_MODE_FIREBASE_CONFIG);
                auth = getAuth(app);
                functions = getFunctions(app); // NEW: Initialize functions service

                onAuthStateChanged(auth, (user) => {
                    currentUser = user;
                    authReady = true; 

                    if (user) {
                        loadProfile(user.uid);
                        loadVWCPackages(user.uid);
                        if (currentView === 'login' || currentView === 'register') {
                            currentView = 'dashboard';
                        }
                    } else {
                        currentUser = null;
                        customerProfile = { name: '', address: '', yearOfBirth: '' };
                        vwcPackages = [];
                        isVWCSubscribed = false;
                        currentView = 'login';
                    }
                    renderApp(); 
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                isFirebaseUnavailable = true;
                authReady = true; 
                renderApp();
            }
        };

        // --- Start Application ---
        console.log("Starting Application...");
        initializeFirebase();
    </script>
</body>
</html>
